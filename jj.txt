#!/bin/bash
set -e

echo "ğŸš€ Starting Ecom Frontend Deployment..."

REPO_URL="https://github.com/amaansodagar786/ecom_frontend/archive/refs/heads/main.zip"

BASE_DIR="/var/www/bancksp.store"
LIVE_DIR="$BASE_DIR/dist-new"

TMP_ZIP="/tmp/ecom_frontend.zip"
TMP_DIR="/tmp/ecom_frontend"
BACKUP_DIR="$BASE_DIR/dist-new-backup-$(date +%Y-%m-%d-%H%M)"

# Safety check
if [ ! -d "$LIVE_DIR" ]; then
  echo "âŒ ERROR: $LIVE_DIR does not exist"
  exit 1
fi

echo "ğŸ“¦ Creating backup..."
cp -r "$LIVE_DIR" "$BACKUP_DIR"

echo "ğŸ§¹ Cleaning temp files..."
rm -rf "$TMP_DIR" "$TMP_ZIP"

echo "â¬‡ï¸ Downloading source..."
wget -q -O "$TMP_ZIP" "$REPO_URL"

echo "ğŸ“‚ Extracting..."
unzip -q "$TMP_ZIP" -d /tmp
mv /tmp/ecom_frontend-main "$TMP_DIR"

cd "$TMP_DIR"

echo "ğŸ“¦ Installing dependencies..."
npm install --silent

echo "ğŸ— Building frontend..."
npm run build

echo "â™» Replacing ONLY required files..."

# Replace assets
rm -rf "$LIVE_DIR/assets"
cp -r "$TMP_DIR/dist/assets" "$LIVE_DIR/"

# Replace index.html
cp "$TMP_DIR/dist/index.html" "$LIVE_DIR/index.html"

echo "ğŸ§¼ Cleaning temp..."
rm -rf "$TMP_DIR" "$TMP_ZIP"

echo "ğŸ”„ Reloading Nginx..."
sudo systemctl reload nginx

echo "âœ… Frontend deployed successfully!"
echo "ğŸ“ Backup created at: $BACKUP_DIR"
